// Build: 2023/7/5 16:08:42 Author: Maasea
(()=>{var h=class{constructor(e){this.concurrency=e,this.queue=[],this.currentlyRunning=0}add(e){this.queue.push(e),this.run()}run(){for(;this.currentlyRunning<this.concurrency&&this.queue.length>0;)this.currentlyRunning++,this.queue.shift()().finally(()=>{this.currentlyRunning--,this.run()})}};var y=class{constructor(t,e,s){this._times=new Map,this.name=t??"",this.debug=s?.debug??!1,t&&this.log(`${t} Start`),this.className=e??"",this.init()}static getInstance(t,e){let s=typeof $task<"u"?"QuanX":"Surge";return y.instances[s]||(y.instances[s]=y.classNames[s](t,s,e)),y.instances[s]}createProxy(t){return new Proxy(t,{get:this.getFn,set:this.setFn})}getFn(t,e,s){return t[e]}setFn(t,e,s,r){return t[e]=s,!0}getJSON(t,e={}){let s=this.getVal(t);return s?JSON.parse(s):e}setJSON(t,e){this.setVal(JSON.stringify(t),e)}msg(t=this.name,e="",s="",r){}log(t){this.debug&&(typeof t=="object"&&(t=JSON.stringify(t)),console.log(t))}timeStart(t){this._times.set(t,Date.now())}timeEnd(t){if(this._times?.has(t)){let e=Date.now()-this._times.get(t);this.log(`${t}: ${e}ms`),this._times.delete(t)}else this.log(`Timer with label ${t} does not exist.`)}exit(){$done({})}reject(){$done()}},b=y;b.instances={},b.classNames={QuanX:(t,e,s)=>new S(t,e,s),Surge:(t,e,s)=>new B(t,e,s)};var g=class extends b{getFn(t,e,s){let r=g.clientAdapter[e]||e;return super.getFn(t,r,s)}setFn(t,e,s,r){let n=g.clientAdapter[e]||e;return super.setFn(t,n,s,r)}init(){try{this.request=this.createProxy($request),this.response=this.createProxy($response)}catch(t){this.log(t.toString())}}getVal(t){return $persistentStore.read(t)}setVal(t,e){$persistentStore.write(t,e)}msg(t=this.name,e="",s="",r){$notification.post(t,e,s,{url:r??""})}async fetch(t){return await new Promise((e,s)=>{let{method:r,body:n,bodyBytes:o,...i}=t,a=o??n,u=a instanceof Uint8Array;$httpClient[r.toLowerCase()]({...i,body:a,"binary-mode":u},(d,l,C)=>{d&&s(d);let O=u?"bodyBytes":"body";e({status:l.status,headers:l.headers,[O]:C})})})}done(t){let e=t.response??t,s,r;e.bodyBytes?(s=e.bodyBytes,delete e.bodyBytes,r={...t},r.response?r.response.body=s:r.body=s):r=t,$done(r)}},B=g;B.clientAdapter={bodyBytes:"body"};var p=class extends b{static transferBodyBytes(t,e){return t instanceof ArrayBuffer?e==="Uint8Array"?new Uint8Array(t):t:t instanceof Uint8Array&&e==="ArrayBuffer"?t.buffer.slice(t.byteOffset,t.byteLength+t.byteOffset):t}init(){try{this.request=this.createProxy($request),this.response=this.createProxy($response)}catch(t){this.log(t.toString())}}getFn(t,e,s){let r=p.clientAdapter[e]||e,n=super.getFn(t,r,s);return e==="bodyBytes"&&(n=p.transferBodyBytes(n,"Uint8Array")),n}setFn(t,e,s,r){let n=p.clientAdapter[e]||e,o=s;return e==="bodyBytes"&&(o=p.transferBodyBytes(o,"Uint8Array")),super.setFn(t,n,o,r)}getVal(t){return $prefs.valueForKey(t)?.replace(/\0/g,"")}setVal(t,e){$prefs.setValueForKey(t,e)}msg(t=this.name,e="",s="",r){$notify(t,e,s,{"open-url":r??""})}async fetch(t){return await new Promise(e=>{let s={url:"",method:"GET"};for(let[r,n]of Object.entries(t))r==="id"?s.sessionIndex=n:r==="bodyBytes"?s.bodyBytes=p.transferBodyBytes(n,"ArrayBuffer"):s[r]=n;t.bodyBytes&&delete s.body,$task.fetch(s).then(r=>{let n={status:200,headers:{}};for(let[o,i]of Object.entries(r))o==="sessionIndex"?n.id=i:o==="bodyBytes"?n.bodyBytes=p.transferBodyBytes(i,"Uint8Array"):o==="statusCode"?n.status=i:n[o]=i;e(n)})})}done(t){let e=t.response??t,s={};for(let[r,n]of Object.entries(e))r==="status"?s.status=`HTTP/1.1 ${n}`:r==="bodyBytes"?s.bodyBytes=p.transferBodyBytes(n,"ArrayBuffer"):s[r]=n;$done(s)}},S=p;S.clientAdapter={id:"sessionIndex",status:"statusCode"};var c=b.getInstance("Comic-Subscribe",{debug:!1});var F="https://rouman5.com/books/",x=/\/books\/([^\/]+)/;async function $(t,e){let s=F+t,r=await c.fetch({url:s,method:"GET",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36"}}),o=T(r.body).props.pageProps.book,i=o.name,a=o.updatedAt;return j(t,i,a,e)&&(c.msg("Comic Subscribe",`${i} \u5DF2\u66F4\u65B0`,a.split("T")[0],s),w(e)),!0}function T(t){let e=/<script id="__NEXT_DATA__" type="application\/json">(.*?)<\/script>/s,s=t.match(e);return s?JSON.parse(s[1]):null}function f(){return c.getJSON("ComicSubscribe",[])}function j(t,e,s,r){let n=r.find(o=>o.comicId===t);if(n){let o=new Date(s),i=n.updateDate?new Date(n.updateDate):0,a=o-i>0;return a&&(n.updateDate=s),a}else return r.push({comicId:t,name:e,updateDate:s}),!0}function w(t){c.setJSON(t,"ComicSubscribe")}function A(t,e,s){let r=/<div class="col"><h5>(.*?)<\/h5><div>/,n="</body></html>",o=s?"unsubscribe":"subscribe",i=s?"btn-warning":"btn-primary",a=s?"\u53D6\u6D88\u8BA2\u9605":"\u6DFB\u52A0\u8BA2\u9605",u=t.match(r)[1],d=`<script type="text/javascript">
    window.onload = function() {
        const targetDivs = Array.from(document.querySelectorAll("div"));
        const targetDiv = targetDivs.find(div => div.className.startsWith("bookid_operations__"));
  
        if (targetDiv) {
            const a = document.createElement("a");
            a.setAttribute("role", "button");
            a.setAttribute("href", \`/${o}/${e}?comicName=${u}\`);
            a.setAttribute("class", \`btn ${i}\`);
            a.setAttribute("style", "margin-right: 1rem");
            a.textContent = "${a}";
            
            targetDiv.appendChild(a);
            
            a.addEventListener("click",async (event)=>{
                event.preventDefault();
                const response = await fetch(event.target.href);
                if (response.status===200){
                    const jsonBody = await response.json();
                    const isSub = jsonBody.subscribe;
                    const newPath = isSub ? "unsubscribe" : "subscribe";
                    const newButtonStyle = isSub ? "btn-warning" : "btn-primary";
                    const newText = isSub ? "\u53D6\u6D88\u8BA2\u9605" : "\u6DFB\u52A0\u8BA2\u9605";
                    
                    a.setAttribute("href","/"+newPath+\`/${e}?comicName=${u}\`);
                    a.setAttribute("class","btn " +newButtonStyle);
                    a.textContent = newText;
                }
            });
        }
};
<\/script>`;return t.replace(n,d+n)}var q=/(?<scheme>.+):\/\/(?<host>[^/]+)\/?(?<path>[^?]+)?\??(?<params>.*)?/,m=class{constructor(e=""){if(this.name="URL v1.0.2",!e)throw new Error("Empty URL");this.parse(e)}parse(e){let{scheme:s,host:r,path:n="",params:o}=e.match(q)?.groups??{};this.scheme=s,this.host=r,this.path=n,this.params=o?o.split("&").reduce((i,a)=>{let[u,d]=a.split("=");return i[u]=d,i},{}):{}}toString(){let e=this.scheme+"://"+this.host+"/"+this.path;return this.params&&(e+="?"+Object.entries(this.params).reduce((s,[r,n],o)=>s+(o?"&":"")+r+"="+n,"")),e}};function v(){let t=f(),e=new h(4);for(let s=0;s<t.length;s++)e.add(()=>$(t[s].comicId,t));c.exit()}function D(){let t=c.request.url,e=c.response.body,s=t.match(x)[1],n=f().some(i=>i.comicId===s),o=A(e,s,n);c.done({body:o})}function N(){let t=c.request.url,e=new m(t),s=e.path,r=decodeURIComponent(e.params.comicName),n=f(),o=s.split("/"),i=o[0],a=o[1],u=!1,d="\u6DFB\u52A0\u8BA2\u9605\u6210\u529F";if(i==="subscribe"){let l=new Date().toISOString();n.push({comicId:a,name:r,updateDate:l}),u=!0}else i==="unsubscribe"&&(n=n.filter(l=>l.comicId!==a),d="\u53D6\u6D88\u8BA2\u9605\u6210\u529F");w(n),c.msg("Comic Subscribe",r,d),c.done({response:{status:200,headers:{"Content-Type":"application/json"},body:JSON.stringify({subscribe:u})}})}var R=$script.type;switch(R){case"cron":v();break;case"http-request":N();break;case"http-response":D();break}})();
